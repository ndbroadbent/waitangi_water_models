# Waitangi Water Models - Project Context

## Overview

GPU-accelerated 2D shallow water simulation for the Waitangi River estuary (Bay of Islands, New Zealand). Models tidal flow, river mixing, and kayak conditions.

## Key Data Sources

### River Flow Data
- **Source:** NRC (Northland Regional Council) Hilltop API
- **Site:** Waitangi at Waimate North Rd
- **Script:** `scripts/plot_river_data.py --days 90`
- **Client:** `src/waitangi/data/nrc_hilltop.py`

**Observed flow statistics:**
- Dry conditions (baseflow): ~0.3-0.35 m³/s
- After rain: ~15 m³/s
- Default simulation: use `--river-flow 0.3` for dry, `--river-flow 15` for rain

### Mangrove Zones
- **Generated by:** `scripts/generate_mangrove_polygon.py`
- **Output:** `waitangi_mangroves.geojson`
- **Elevation thresholds:**
  - Lower: 0.0m (mean sea level) - below is permanently flooded mudflat
  - Upper: 1.1m (high tide) - above is dry land
  - Mangroves exist in this intertidal band
- **Manning's n:** Use ~0.12-0.15 for mangroves (vs 0.035 for open water)

### Elevation Data
- **Source:** LINZ LiDAR DEM (1m resolution)
- **Fetched via:** `waitangi.data.elevation.fetch_waitangi_elevation()`
- **Coordinate system:** NZTM2000 (EPSG:2193)

### Tidal Parameters
- **Range:** -0.5m to +1.1m (1.6m total)
- **Period:** 12.42 hours (M2 semidiurnal)
- **Reference port:** Opua

## Simulation Details

### Wall/Dam Boundary Approach
The simulation uses a "dam spillway" approach for the tidal boundary:
- 1-cell-wide wall at column 350
- Wall height = current tide level
- Rising tide: water flows in over the wall
- Falling tide: water spills out and leaves simulation
- z_bed is FIXED during simulation - only eta changes at wall cells

### Physical Parameters
- Grid: 319 x 410 cells at 8m resolution (downsampled from 1m)
- Timestep: ~0.25s (CFL-limited)
- Manning's n: 0.035 (open water), 0.12-0.15 (mangroves)
- Max velocity: 3.0 m/s

### Key Volume Comparison
At mean river flow (1 m³/s) over one tidal cycle:
- River volume: ~45,000 m³
- Tidal prism: ~1.4 million m³
- **Ratio: Tide is ~30x larger than river!**

This explains why river water (green tracer) pools near Haruru Falls - the estuary is heavily tide-dominated.

## Scripts

| Script | Purpose |
|--------|---------|
| `scripts/tidal_cycle_simulation.py` | Main JAX/GPU tidal simulation |
| `scripts/tidal_cycle_simulation.py test` | Quick equilibrium test |
| `scripts/plot_river_data.py --days N` | Fetch and plot NRC gauge data |
| `scripts/generate_mangrove_polygon.py` | Generate mangrove zone geojson |
| `scripts/simple_tidal_test.py` | Earlier NumPy-based test |

## JAX/GPU Notes

- Uses JAX with Metal backend (Apple Silicon)
- Requires jax==0.4.35, jaxlib==0.4.35, jax-metal==0.1.1
- Must use 32-bit precision: `jax.config.update("jax_enable_x64", False)`
- Achieves ~430 steps/s on M2 Pro
