# Waitangi Water Models - Project Context

## Overview

GPU-accelerated 2D shallow water simulation for the Waitangi River estuary (Bay of Islands, New Zealand). Models tidal flow, river mixing, and kayak conditions.

## Project Structure

```
waitangi_water_models/
├── src/waitangi/
│   ├── data/
│   │   ├── elevation.py          # Fetches LINZ LiDAR DEM from cloud
│   │   ├── estuary_geometry.py   # Bounding boxes, visualization areas
│   │   ├── nrc_hilltop.py        # NRC river flow API client
│   │   └── reference_points.py   # Ground-truth coordinates
│   └── core/
│       └── config.py             # WaitangiLocation constants, CRS definitions
├── scripts/
│   ├── tidal_cycle_simulation.py # Main JAX/GPU simulation
│   ├── plot_river_data.py        # Fetch/plot NRC gauge data
│   └── generate_mangrove_polygon.py
├── tests/
├── pyproject.toml                # uv/pip dependencies
└── CLAUDE.md                     # This file
```

**Note:** There is no local `data/` directory - elevation data is fetched from LINZ cloud on first run and cached to disk at `~/.cache/waitangi_water_models/`.

## Key Data Sources

### River Flow Data
- **Source:** NRC (Northland Regional Council) Hilltop API
- **Site:** Waitangi at Waimate North Rd
- **Script:** `scripts/plot_river_data.py --days 90`
- **Client:** `src/waitangi/data/nrc_hilltop.py`

**Observed flow statistics:**
- Dry conditions (baseflow): ~0.3-0.35 m³/s
- After rain: ~15 m³/s
- Default simulation: use `--river-flow 0.3` for dry, `--river-flow 15` for rain

### Mangrove Zones
- **Generated by:** `scripts/generate_mangrove_polygon.py`
- **Output:** `waitangi_mangroves.geojson`
- **Elevation thresholds:**
  - Lower: 0.0m (mean sea level) - below is permanently flooded mudflat
  - Upper: 1.1m (high tide) - above is dry land
  - Mangroves exist in this intertidal band
- **Manning's n:** Use ~0.12-0.15 for mangroves (vs 0.035 for open water)

### Elevation Data
- **Source:** LINZ LiDAR DEM (1m resolution) - Cloud-Optimized GeoTIFFs
- **URL:** `https://nz-elevation.s3.ap-southeast-2.amazonaws.com/new-zealand/new-zealand/dem_1m/2193/AV29.tiff`
- **Fetched via:** `waitangi.data.elevation.fetch_waitangi_elevation()` (in `src/waitangi/data/elevation.py`)
- **Coordinate system:** NZTM2000 (EPSG:2193)
- **Grid bounds (NZTM):** west=1695441, south=6094774, east=1698716, north=6097323
- **Raw shape:** 2549 x 3275 at 1m resolution
- **Downsampled:** 8x to 319 x 410 at 8m resolution

### Tidal Parameters
- **Range:** -0.5m to +1.1m (1.6m total)
- **Period:** 12.42 hours (M2 semidiurnal)
- **Reference port:** Opua

## Simulation Details

### Wall/Dam Boundary Approach
The simulation uses a "dam spillway" approach for the tidal boundary:
- 1-cell-wide wall at column 350
- Wall height = current tide level
- Rising tide: water flows in over the wall
- Falling tide: water spills out and leaves simulation
- z_bed is FIXED during simulation - only eta changes at wall cells

### Physical Parameters
- Grid: 319 x 410 cells at 8m resolution (downsampled from 1m)
- Timestep: ~0.25s (CFL-limited)
- Manning's n: 0.035 (open water), 0.12-0.15 (mangroves)
- Max velocity: 3.0 m/s

### Key Volume Comparison
At mean river flow (1 m³/s) over one tidal cycle:
- River volume: ~45,000 m³
- Tidal prism: ~1.4 million m³
- **Ratio: Tide is ~30x larger than river!**

This explains why river water (green tracer) pools near Haruru Falls - the estuary is heavily tide-dominated.

## Scripts

| Script | Purpose |
|--------|---------|
| `scripts/tidal_cycle_simulation.py` | Main JAX/GPU tidal simulation |
| `scripts/tidal_cycle_simulation.py test` | Quick equilibrium test |
| `scripts/plot_river_data.py --days N` | Fetch and plot NRC gauge data |
| `scripts/generate_mangrove_polygon.py` | Generate mangrove zone geojson |
| `scripts/simple_tidal_test.py` | Earlier NumPy-based test |

## Reference Points

All ground-truth coordinates are in `src/waitangi/data/reference_points.py`:
- **LANDMARKS**: Boat Ramp (-35.270798, 174.078968), Waitangi Bridge, Haruru Falls
- **WATER_POINTS_WEST/EAST**: Known navigable water points
- **LAND_POINTS**: Known land areas (never flooded)
- **MANGROVE_POINTS**: Intertidal zones (flooded at high tide, not navigable)

Used by `scripts/validate_geometry.py` for geometry validation.

## JAX/GPU Notes

- Uses JAX with Metal backend (Apple Silicon)
- Requires jax==0.4.35, jaxlib==0.4.35, jax-metal==0.1.1
- Must use 32-bit precision: `jax.config.update("jax_enable_x64", False)`
- Achieves ~430 steps/s on M2 Pro
